# ğŸš€ PIPELINE CI/CD - Deploy AutomÃ¡tico no Azure
# 
# ï¿½ COMO USAR:
# 1. FaÃ§a mudanÃ§as no cÃ³digo e commit
# 2. Push para a branch 'main' 
# 3. A pipeline roda automaticamente
#
# Ou execute manualmente via "Actions" â†’ "Run workflow"

name: Deploy Git Game to Azure

# ğŸ¯ QUANDO EXECUTAR
on:
## push:
## branches: [ main ]  # A cada push na branch main
  workflow_dispatch:     # Ou manualmente via interface do GitHub
    inputs:
      confirm:
        description: 'Digite "APPLY" para confirmar'
        required: true
        default: ''

# ğŸŒ VARIÃVEIS GLOBAIS
env:
  REGISTRY_NAME: gitgame
  
# ğŸ’¼ JOBS
jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # ğŸ PASSO 1: Baixar cÃ³digo do repositÃ³rio
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    # ğŸ PASSO 2: Autenticar no Azure
    - name: ğŸ”‘ Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    # ğŸ PASSO 3: Instalar Terraform
    - name: ğŸ—ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.5.0
        
    # ğŸ PASSO 4: Preparar Terraform
    - name: ğŸ”§ Terraform Init
      run: |
        cd terraform
        export ARM_CLIENT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}"
        export ARM_CLIENT_SECRET="${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}"
        export ARM_TENANT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}"
        export ARM_SUBSCRIPTION_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}"
        
        terraform init
        
    # ğŸ PASSO 5: Planejar infraestrutura bÃ¡sica
    - name: ğŸ“‹ Terraform Plan
      run: |
        cd terraform
        export ARM_CLIENT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}"
        export ARM_CLIENT_SECRET="${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}"
        export ARM_TENANT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}"
        export ARM_SUBSCRIPTION_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}"
        
        terraform plan -target=azurerm_resource_group.gitgame -target=azurerm_container_registry.gitgame -target=random_string.suffix
        
    # ğŸ PASSO 6: Criar infraestrutura bÃ¡sica
    - name: ğŸš€ Create Infrastructure
      run: |
        cd terraform
        export ARM_CLIENT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}"
        export ARM_CLIENT_SECRET="${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}"
        export ARM_TENANT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}"
        export ARM_SUBSCRIPTION_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}"
        
        terraform apply -auto-approve -target=azurerm_resource_group.gitgame -target=azurerm_container_registry.gitgame -target=random_string.suffix
        
    # ğŸ³ PASSO 7: Build das imagens
    - name: ï¿½ Build and Push Images
      run: |
        # Configurar Terraform
        export ARM_CLIENT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}"
        export ARM_CLIENT_SECRET="${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}"
        export ARM_TENANT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}"
        export ARM_SUBSCRIPTION_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}"
        
        # Buscar info do registry
        ACR_SERVER=$(cd terraform && terraform output -raw acr_login_server)
        ACR_USERNAME=$(cd terraform && terraform output -raw acr_admin_username)
        ACR_PASSWORD=$(cd terraform && terraform output -raw acr_admin_password)
        RANDOM_SUFFIX=$(cd terraform && terraform output -raw random_suffix)
        
        # Login no registry
        echo $ACR_PASSWORD | docker login $ACR_SERVER -u $ACR_USERNAME --password-stdin
        
        # Build e push das imagens
        docker build -t $ACR_SERVER/gitgame-db:latest ./db
        docker push $ACR_SERVER/gitgame-db:latest
        
        docker build -t $ACR_SERVER/gitgame-backend:latest ./backend
        docker push $ACR_SERVER/gitgame-backend:latest
        
        # Frontend com URL da API
        docker build \
          --build-arg VITE_API_URL="http://gitgame-${RANDOM_SUFFIX}.eastus.azurecontainer.io:8000" \
          -t $ACR_SERVER/gitgame-frontend:latest ./frontend
        docker push $ACR_SERVER/gitgame-frontend:latest
        
    # ğŸš€ PASSO 8: Deploy dos containers
    - name: ğŸ—ï¸ Deploy Containers
      run: |
        cd terraform
        export ARM_CLIENT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}"
        export ARM_CLIENT_SECRET="${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}"
        export ARM_TENANT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}"
        export ARM_SUBSCRIPTION_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}"
        
        # ForÃ§a recriaÃ§Ã£o dos containers para usar imagens atualizadas
        if terraform state show azurerm_container_group.gitgame >/dev/null 2>&1; then
          terraform taint azurerm_container_group.gitgame
        fi
        
        terraform apply -auto-approve
        
    # âœ… PASSO 9: URLs da aplicaÃ§Ã£o
    - name: ğŸ® Show Application URLs
      run: |
        cd terraform
        export ARM_CLIENT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}"
        export ARM_CLIENT_SECRET="${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}"
        export ARM_TENANT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}"
        export ARM_SUBSCRIPTION_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}"
        
        echo "ğŸ® Git Game URLs:"
        echo "ğŸŒ Frontend: $(terraform output -raw application_url)"
        echo "ğŸ”— API: $(terraform output -raw api_url)"
        echo ""
        echo "ğŸ‰ Deploy concluÃ­do! Aguarde 2-3 minutos para ficar disponÃ­vel."